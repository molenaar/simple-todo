<!--
Document Generated by: John (pm), AI Product Manager
Date: September 4, 2025
Version: 1.0
-->

# Product Requirements Document: Course Content Upload Feature

## 1. Introduction: Project Analysis and Context

*   **Project Name**: Courseware Schedule Content Upload
*   **Author**: Marcel Molenaar
*   **Date**: September 4, 2025
*   **Version**: 1.0
*   **Target Release**: `0.0.2`

### 1.1. Problem Statement
Content managers lack a simple, web-based method to upload and update course markdown files. The current process requires developer intervention, manual file transfers, and direct interaction with Azure Storage, which is inefficient, error-prone, and creates a bottleneck for content updates.

### 1.2. Project Goal
To create a secure, user-friendly web interface that allows authorized users to upload new or updated course markdown files directly into the existing Azure Storage infrastructure. This will streamline the content management workflow, empower content managers, and reduce reliance on the development team for routine updates.

### 1.3. Current State Analysis
The `courseware-schedule` project is a functional Astro v5 application that dynamically displays course schedules from markdown files stored in Azure Blob Storage. It utilizes Azure Functions for its backend API and Azure Table Storage for metadata. The core architecture is sound, but the content update process is entirely manual and requires technical expertise.

### 1.4. Out of Scope for This Release
*   A comprehensive user authentication and authorization system. For this initial release, the upload page will be located on a non-public, "security by obscurity" URL.
*   A user interface for deleting or renaming files in storage.
*   A WYSIWYG (What You See Is What You Get) editor for creating or editing markdown content from scratch within the browser.

---

## 2. Requirements

### 2.1. Functional Requirements
1.  **File Upload**: The system must provide an interface to upload a `.md` file from the user's local machine.
2.  **Paste Markdown**: The system must provide a `<textarea>` to allow users to paste raw markdown content as an alternative to file upload.
3.  **Overwrite Confirmation**: The system must ask for explicit user confirmation via a dialog box before overwriting an existing file in storage.
4.  **API Endpoint**: A backend API endpoint (`/api/upload`) must be created to securely receive and process the uploaded content.
5.  **Front Matter Validation**: The API must parse and validate the markdown's front matter against the project's defined schema in `app/src/content.config.ts`.
6.  **Data Persistence**: The API must save the validated markdown file to the `course-content` Azure Blob Storage container using the `{courseId}-{format}.md` naming convention.
7.  **Metadata Update**: The API must create or update the corresponding course metadata in the `courses` Azure Table to ensure the new content is discoverable.
8.  **Feedback Mechanism**: The UI must provide clear, immediate, and easy-to-understand feedback to the user on the status of the upload (e.g., "Success," "Error: Invalid Front Matter").

### 2.2. Non-Functional Requirements
1.  **Security**: The API endpoint must sanitize all incoming data to prevent XSS or other injection attacks.
2.  **Usability**: The upload interface should be simple, intuitive, and require no technical knowledge or training to operate.
3.  **Performance**: The upload process must be asynchronous and not block the user interface, providing a smooth user experience even with larger files.

---

## 3. User Interface Enhancement Goals

### 3.1. New Component: `UploadInterface.astro`
A new, self-contained Astro component will be created to encapsulate the entire upload functionality.

### 3.2. Placement and Accessibility
This component will be placed on a new, non-public admin page located at `app/src/pages/admin/upload.astro`. This page will not be linked from any public-facing navigation menus, sidebars, or sitemaps.

### 3.3. UI Elements and Workflow
The interface will be clean and functional, containing:
*   A clear heading: "Upload Course Content".
*   A file input control restricted to `.md` files.
*   A `<textarea>` for pasting raw markdown.
*   A checkbox labeled "Overwrite existing file?".
*   A "Submit" button to initiate the upload.
*   A dedicated status area to display success, error, or progress messages.

### 3.4. Content Rendering
As per existing project architecture, the uploaded markdown content will be rendered on the dynamic course pages (`app/src/pages/coursecollections/[course].astro`) as direct HTML, ensuring a seamless and performant display.

---

## 4. Technical Constraints and Integration Requirements

### 4.1. Existing Technology Stack
The enhancement will be built upon the existing project technology stack:
*   **Frontend**: Astro v5 (Static Site Generation)
*   **Styling**: Tailwind CSS v4
*   **Client-side Scripting**: TypeScript
*   **Backend API**: Azure Functions (Node.js 18+)
*   **Database**: Azure Table Storage (for metadata) and Azure Blob Storage (for markdown content)
*   **Local Development**: Azurite for local Azure Storage emulation

### 4.2. Integration Approach
*   **API Integration**: The `UploadInterface.astro` component will communicate with a new Azure Function (`/api/upload`) via a `POST` request.
*   **Database Integration**:
    *   **Blob Storage**: The API will upload the validated markdown file to the `course-content` container.
    *   **Table Storage**: The API will update the `courses` table with the metadata.
*   **Content Integration**: The solution must adhere to Astro's Content Collections approach.
    *   **Front Matter Enrichment**: The API must enrich the markdown's front matter (e.g., adding `lastUpdated` date).
    *   **API Validation**: The `/api/upload` function is responsible for validating the incoming data against the schema in `app/src/content.config.ts`.

### 4.3. Code Organization and Standards
*   **Component Location**: `app/src/components/UploadInterface.astro`
*   **API Location**: `api/src/functions/UploadCourse/`
*   **Type Safety**: All new code must be strongly typed using TypeScript.

### 4.4. Deployment and CI/CD
*   **Deployment Method**: Deployment is automated via the GitHub Actions workflow in `.github/workflows/azure-static-web-apps-black-tree-0fb59a003.yml`.
*   **Hosting Environment**: The project is hosted on the Azure Static Web App free plan with managed functions available at the `/api` path.

### 4.5. Technical Risk Assessment

| Risk Category | Description | Mitigation Strategy |
| :--- | :--- | :--- |
| **Performance** | Large file uploads could block the UI. | Implement asynchronous uploads with progress indicators. |
| **Security** | Unsanitized markdown could introduce XSS vulnerabilities. | The API must sanitize all incoming markdown content before storing it. |
| **Data Integrity** | An upload might succeed for the blob but fail for the table metadata. | The API function must use a transactional approach: if the Table Storage write fails, the uploaded blob will be deleted. |
| **Architecture** | **Server-Side Rendering (SSR) is not supported** on Azure Static Web Apps. | The application must continue to use Astro's static generation (`output: 'static'`) with `getStaticPaths`. |
| **Dependencies** | **SAS Token Expiration**. In production, `generateSas` is mandatory. Tokens can expire. | The client-side logic must gracefully handle potential 500 errors from the API that could result from an expired SAS token. |

---

## 5. Epic and Story Structure

### Epic: Enable Course Content Upload and Management

> As a Content Manager, I want to be able to upload and manage course markdown files directly through a web interface, so that I can update course content without needing developer assistance or manual file transfers.

---

### User Stories:

**Story 1: Create the File Upload Interface**
*   **As a** Content Manager, **I want** a simple user interface on a dedicated admin page, **So that** I can select a markdown file or paste markdown text to be uploaded.
*   **Acceptance Criteria:**
    *   A new Astro component (`UploadInterface.astro`) is created.
    *   The interface contains a file input for `.md` files and a `<textarea>`.
    *   A "Submit" button and an "Overwrite existing file?" checkbox are present.

**Story 2: Implement the Backend Upload API Endpoint**
*   **As a** Developer, **I want** a secure API endpoint (`/api/upload`), **So that** it can receive and process the markdown content on the server.
*   **Acceptance Criteria:**
    *   A new Azure Function is created at `api/src/functions/UploadCourse/`.
    *   The function responds to `POST` requests at the `/api/upload` route.
    *   It correctly receives content from the request body and validates it is not empty.

**Story 3: Add Front Matter Validation and Enrichment**
*   **As a** Developer, **I want** the API to parse, validate, and enrich the markdown's front matter, **So that** all content adheres to the `content.config.ts` schema.
*   **Acceptance Criteria:**
    *   The API successfully parses the front matter.
    *   It validates all required fields and types.
    *   It enriches the `lastUpdated` field.
    *   Returns a `400 Bad Request` with a clear message if validation fails.

**Story 4: Implement Blob and Table Storage Logic**
*   **As a** Developer, **I want** the API to save the file to Blob Storage and its metadata to Table Storage, **So that** the new content is persisted and discoverable.
*   **Acceptance Criteria:**
    *   The API constructs the blob name (`{courseId}-{format}.md`).
    *   The content is uploaded to the `course-content` blob container.
    *   The metadata is saved to the `courses` Azure Table.
    *   The operation is atomic (blob is deleted if table write fails).

**Story 5: Implement Client-Side Upload Logic and User Feedback**
*   **As a** Content Manager, **I want** to see the status of my upload, **So that** I know if the operation was successful or if there was a problem.
*   **Acceptance Criteria:**
    *   Client-side TypeScript handles the `fetch` request.
    *   The UI displays a loading indicator.
    *   A confirmation dialog appears if "Overwrite" is checked.
    *   Success or error messages from the API are displayed to the user.

**Story 6: Create Admin Page and Integrate Component**
*   **As a** Developer, **I want** to create a new, non-public admin page, **So that** the upload interface is accessible to authorized users.
*   **Acceptance Criteria:**
    *   A new page is created at `app/src/pages/admin/upload.astro`.
    *   The `UploadInterface.astro` component is embedded and functional.
    *   The page is not linked from any public-facing navigation.
